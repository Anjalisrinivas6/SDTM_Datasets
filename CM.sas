/*DERVING CM SDTM DOMAIN*/




 OPTIONS VALIDVARNAME = UPCASE MISSING = '';

proc sort DATA = Raw. Nsmed out = CM;
BY PATIENT;
RUN;
DATA CM1;
SET CM (drop= studyid);
STUDYID = STUDY;
DOMAIN = 'CM';
USUBJID = CATX("-", STUDY, STDYSITE,PATIENT);
CMTRT = STrip(MEDX);
CMMODIFY = strip(CMTRT);
CMDECOD = MEDPTX ;
CMCAT = UPCASE( LBLSTYP );
CMSCAT = UPCASE (TMTTYP);
CMINDC = strip(TMTRSNX) ;
CMCLAS = strip(ATC4X );
CMCLASCD = ATC4C ;
CMDOSE = DOSE ;

If  Doseu not in ("mg","mEq","cc","U","g","IU","mcg","mg/m2","mg/ml","ml","mg/kg","U/ml","M Units","%") 
then CMDOSU=Strip(DOSEU);
else CMDOSU='';



IF Doseu not in ("mg","mEq","cc","U","g","IU","mcg","mg/m2","mg/ml","ml","mg/kg","U/ml","M Units","%") 
then CMDOSFRM = Strip(DOSEU);
else CMDOSFRM='';

CMDOSFRQ = strip(FREQ) ;
CMROUTE = strip(ROUTE);




IF STARTDTP='DY' THEN CMSTDTC_=STRIP(CMSTDTC);
IF STARTDTP='MO' THEN CMSTDTC_=SUBSTR(CMSTDTC,1,7);
IF STARTDTP='YR' THEN CMSTDTC_=STRIP(SUBSTR(CMSTDTC,1,4));

IF STOPDTP='DY' THEN CMENDTC_=STRIP(CMENDTC);
IF STOPDTP='MO' THEN CMENDTC_=SUBSTR(CMENDTC,1,7);
IF STOPDTP='YR' THEN CMENDTC_=STRIP(SUBSTR(CMENDTC,1,4));




 CMSTDT = Input(CMSTDTC_,YYMMDD10.);
 CMENDT = Input(CMENDTC_ ,YYMMDD10.);
 FORMAT CMSTDT CMENDT is8601da. ;

IF CMENDT ne . and CMSTDT ne . then 
CMDUR_ =  CMENDT-CMSTDT + 1  ;
else CMDUR_ = . ;

CMDUR = PUT(CMDUR_, IS8601DA.);
CMSTRF = '';

IF CMENDTC EQ '' then  CMENRF='ONGOING';


KEEP STUDYID DOMAIN USUBJID CMTRT CMMODIFY CMDECOD CMCAT CMSCAT CMINDC CMCLAS CMCLASCD CMDOSE CMDOSU CMDOSFRM CMDOSFRQ
CMROUTE CMSTDTC_  CMENDTC_ CMDUR CMSTRF CMENRF;

RUN;
 





/*DERIVING CMSTDY,CMENDY,EPOCH*/

PROC SORT DATA= sdtm.DM OUT=DM(KEEP=USUBJID RFSTDTC RFENDTC);
BY USUBJID;
RUN;

PROC SORT DATA=cm1 OUT = CM ;
BY USUBJID;
RUN;

DATA cm_dm;
MERGE cm(IN=A) DM(IN=B);
BY USUBJID;
IF A AND B;
RUN;

DATA cm_dy;
SET cm_dm;
IF RFSTDTC NE '' THEN RFSTDT=INPUT(RFSTDTC,YYMMDD10.);
IF RFENDTC NE '' THEN RFENDT=INPUT(RFENDTC,YYMMDD10.);

If length(CMSTDTC) = 10 THEN  CMSTDT=INPUT(CMSTDTC,YYMMDD10.);


If length (CMENDTC)= 10 THEN CMENDT=INPUT(CMENDTC,YYMMDD10.);

FORMAT RFSTDT RFENDT CMSTDT CMENDT IS8601DA.;

IF NMISS(CMSTDT,RFSTDT)=0 THEN DO;
IF CMSTDT<RFSTDT THEN CMSTDY=CMSTDT-RFSTDT;
ELSE IF CMSTDT>=RFSTDT THEN CMSTDY=(CMSTDT-RFSTDT)+1;
END;


IF NMISS(CMENDT,RFSTDT)=0 THEN DO;
IF CMENDT<RFSTDT THEN CMENDY=CMENDT-RFSTDT;
ELSE IF CMENDT>=RFSTDT THEN CMENDY=(CMENDT-RFSTDT)+1;
END;


IF CMSTDT <RFSTDT THEN EPOCH='SCREENING';
ELSE IF CMSTDT>=RFSTDT AND CMSTDT <=RFENDT THEN EPOCH='TREATMENT';
ELSE IF CMSTDT>RFENDT THEN EPOCH='FOLLOW-UP';


RUN;





/*DERIVING THE SEQUENCE NUMBER*/


PROC SORT DATA=CM_DY OUT=CMDY NODUPKEY DUPOUT=X;
BY USUBJID CMTRT CMSTDTC CMENDTC ;
RUN;

PROC SORT DATA=CMDY;
BY USUBJID CMTRT CMSTDTC;
RUN;

DATA CMSEQ_;
SET CMDY;
BY USUBJID ;
IF FIRST.USUBJID THEN CMSEQ=1;
ELSE CMSEQ+1;
RUN;



DATA SDTM.CM1;
SET CMSEQ;
ATTRIB
STUDYID LABEL='Study Identifier'
DOMAIN	LABEL='DM'
USUBJID	LABEL='Unique Subject Identifier'
CMSEQ	LABEL='Sequence Number'
CMTRT LABEL = 'Reported Name of Drug, Med, or Therapy'
CMMODIFY LABEL = 'Modified Reported Name'
CMDECOD LABEL = 'Standardized Medication Name'
CMCAT LABEL= 'Category for Medication'
CMSCAT LABEL = 'Subcategory for Medication'
CMINDC LABEL = 'Indication'
CMCLAS LABEL = 'Medication Class'
CMCLASCD LABEL = 'Medication Class Code'
CMDOSE LABEL = 'Dose per Administation'
CMDOSU LABEL = 'Dose Units'
CMDOSFRM LABEL = 'Dose Form'
CMDOSFRQ LABEL = 'Dosing Frequency per Interval'
CMROUTE LABEL = 'Route of Administration'
EPOCH LABEL = 'EPOCH'
CMSTDTC LABEL  = 'Start Date/Time of Medication'
CMENDTC LABEL = 'End Date/Time of Medication'
CMSTDY LABEL = 'Study Day of Start of Medication'
CMENDY LABEL = 'Study Day of End of Medication'
CMDUR LABEL = 'Duration of Medication'
CMSTRF LABEL = 'Start Relative to Reference Period'
CMENRF LABEL = 'End Relative to Reference Period';
RUN;
















